const hiveClient=new dsteem.Client('https://api.hive.blog');const steemClient=new dsteem.Client('https://api.steemit.com');blurt.api.setOptions({url:"https://rpc.blurt.world",useAppbaseApi:true})
async function checkAccountName(username,chain){let ac;if(chain==='blurt'){[ac]=await blurt.api.getAccountsAsync([username]);}else if(chain==='steem'){[ac]=await steemClient.database.call('lookup_account_names',[[username]]);}else{[ac]=await hiveClient.database.call('lookup_account_names',[[username]]);}
return(ac===undefined||ac===null)?true:false;}
function suggestPassword(){const array=new Uint32Array(10);window.crypto.getRandomValues(array);return 'P'+dsteem.PrivateKey.fromSeed(array).toString();}
function getPrivateKeys(username,password,roles=['owner','active','posting','memo']){const privKeys={};roles.forEach((role)=>{privKeys[role]=dsteem.PrivateKey.fromLogin(username,password,role).toString();privKeys[`${role}Pubkey`]=dsteem.PrivateKey.from(privKeys[role]).createPublic().toString();});return privKeys;};$(document).ready(async function(){var current_fs,next_fs,previous_fs;var opacity;var current=1;var steps=$("fieldset").length;let settings={};setProgressBar(current);$(".next").click(async function(){if(current===1){let username=$('#username').val().toLowerCase().trim();if(username!==""){let isAvailable=false;let letterNumber=/^[a-z]+(\.|\-)?[a-z0-9]{3,}$/;if(username.length>=3&&username.match(letterNumber)&&username.length<16){try{isAvailable=await checkAccountName(username,'blurt');}catch(e){console.log(e)}}
if(isAvailable){current_fs=$(this).parent();next_fs=$(this).parent().next();$("#progressbar li").eq($("fieldset").index(next_fs)).addClass("active");next_fs.show();current_fs.animate({opacity:0},{step:function(now){opacity=1-now;current_fs.css({'display':'none','position':'relative'});next_fs.css({'opacity':opacity});},duration:500});setProgressBar(++current);}}else{}}else if(current==2){let password=$('#password').val().trim();if(password!==""){current_fs=$(this).parent();next_fs=$(this).parent().next();$("#progressbar li").eq($("fieldset").index(next_fs)).addClass("active");next_fs.show();current_fs.animate({opacity:0},{step:function(now){opacity=1-now;current_fs.css({'display':'none','position':'relative'});next_fs.css({'opacity':opacity});},duration:500});setProgressBar(++current);}}});$(".previous").click(function(){current_fs=$(this).parent();previous_fs=$(this).parent().prev();$("#progressbar li").eq($("fieldset").index(current_fs)).removeClass("active");previous_fs.show();current_fs.animate({opacity:0},{step:function(now){opacity=1-now;current_fs.css({'display':'none','position':'relative'});previous_fs.css({'opacity':opacity});},duration:500});setProgressBar(--current);});function setProgressBar(curStep){var percent=parseFloat(100/steps)*curStep;percent=percent.toFixed();$(".progress-bar").css("width",percent+"%")}
$.getJSON(`/settings`).done(function(res){settings=res;$('#fee').text(settings.account_creation_fee.credit);$('#delegation').text(settings.gift_amount.credit);$('#faucet').text(settings.daily_faucet.credit);$('#username-input').hide();$('#payer').removeAttr('required');});$('input[name="chain"]').change(()=>{const chain=$('input[name=chain]:checked').val();$('#fee').text(settings.account_creation_fee[chain]);$('#delegation').text(settings.gift_amount[chain]);$('#faucet').text(settings.daily_faucet[chain]);$('#blockchain').text(chain.toUpperCase());$('#username-input').show();document.getElementById("payer").required=true;if(chain==='credit'||chain==='coinbase'){$('#username-input').hide();$('#payer').removeAttr('required');}});$('#username').on('input',async function(){let letterNumber=/^[a-z]+(\.|\-)?[a-z0-9]{3,}$/;let username=$(this).val().toLowerCase();if(username.length>=3&&username.match(letterNumber)&&username.length<16){try{const ac=await checkAccountName(username,'blurt');(!ac)?$(this).removeClass('is-valid').addClass('is-invalid'):$(this).removeClass('is-invalid').addClass('is-valid');}catch(e){console.log(e)}}else{$(this).removeClass('is-valid').addClass('is-invalid');}});$('#payer').on('input',async function(){const chain=$('input[name="chain"]:checked').val();const ac=await checkAccountName($(this).val().toLowerCase(),chain);(ac)?$(this).removeClass('is-valid').addClass('is-invalid'):$(this).removeClass('is-invalid').addClass('is-valid');(ac)?document.getElementById('submit').disabled=true:document.getElementById('submit').disabled=false;});$('#password').val(suggestPassword());$('#regen-password').click(function(e){e.preventDefault();$('#password').val(suggestPassword());});$('#download-password').click(function(e){e.preventDefault();const username=$('#username').val().toLowerCase();const password=$('#password').val();const keys=getPrivateKeys(username,password);const text=`Username: ${username}\nMaster password: ${password}\nOwner key: ${keys.owner}\nActive key: ${keys.active}\nPosting key: ${keys.posting}\nMemo key: ${keys.memo}`;var file=new File([text],`${username}-backup.txt`,{type:"text/plain;charset=utf-8"});saveAs(file);});$('#msform').submit(async function(e){e.preventDefault();$('#alert').removeClass('alert-success').removeClass('alert-danger').empty();let urlParams=new URLSearchParams(window.location.search);let referral=urlParams.get('referral')===null?'':urlParams.get('referral');if(referral!==''){let notFound=await checkAccountName(referral,'blurt');if(notFound){referral='';}}
const username=$('#username').val().toLowerCase();const password=$('#password').val();const chain=$('input[name="chain"]:checked').val();const payee=$('#payee').val();const payer=chain==='credit'?payee:$('#payer').val().toLowerCase();const fee=$('#fee').val();$.ajax({type:'POST',url:`/createAccount`,contentType:'application/json',dataType:'json',data:JSON.stringify({username:username,password:password,payer:payer,chain:chain,fee,payee,referral}),}).done(function(res){if(!res.success){let errors=[];res.errors.forEach(e=>errors.push(`<li>${e}</li>`));$('#alert').addClass('alert-danger').html(`<ul class="mb-0">${errors.join('')}</ul>`);}
if(res.success){window.location=`status.html?id=${res.data.order_id}`;}}).fail(function(jqXHR,textStatus,errorThrown){console.log(errorThrown);});});});